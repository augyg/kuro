# Runs the AWS Kadena load test
- import_playbook: run_servers.yml

- name: Run Load Test
  hosts: localhost
  gather_facts: False
  vars_prompt:
    - name: "total"
      prompt: "Total number of transactions:"
      default: "120000"
      private: no
    - name: "size"
      prompt: "Batch size:"
      default: "3000"
      private: no
  tasks:
    - name: Clean up result directory (if it exists)
      file:
        path: /home/ubuntu/result/
        state: absent

    - name: Create result directory
      file:
        path: /home/ubuntu/result/
        state: directory
        owner: ubuntu
        mode: 0755
    
    - name: Make Bolosim Executable
      file:
        path: /home/ubuntu/kadena-beta/bin/ubuntu-16.04/bolosim
        mode: a+x

    - name: Run Bolosim Test
      command: rlwrap -A /home/ubuntu/kadena-beta/bin/ubuntu-16.04/bolosim -e --transactions={{total}}  --batchsize={{size}} --norunserver --configfile=client.yaml --dirforconfig=/home/ubuntu/conf/
      args:
        chdir: /home/ubuntu/kadena
      register: result

    - name: Write Result of Bolosim Load Test to File
      copy: content={{ result.stdout }} dest=/home/ubuntu/result/result.log

    - pause:
        seconds: 2

- name: Fetch Kadena Servers' log files
  hosts: tag_Name_kadena_server
  become: True
  gather_facts: False
  vars:
    ansible_python_interpreter: /usr/bin/python3
  tasks:
    - synchronize:
        src: /home/ubuntu/log/*sqlite
        dest: /home/ubuntu/result/{{ hostvars[inventory_hostname].ec2_private_ip_address }}-log/
        mode: pull
    - synchronize:
        src: /home/ubuntu/log/*log
        dest: /home/ubuntu/result/{{ hostvars[inventory_hostname].ec2_private_ip_address }}-log/
        mode: pull
