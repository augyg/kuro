### (Re)start Kadena Servers

- name: Configure instance(s)
  hosts: kadena_all
  become: True
  vars:
    ansible_python_interpreter: /usr/bin/python3
  gather_facts: False
  tasks:
    - name: Identify Thread Running Kadena Server (if running)
      command: pgrep kadenaserver
      register: server_thread

    - name: Terminate Kadena Server Thread (if running)
      become: True
      command: kill "{{ server_thread.stdout }}"
      when: "server_thread.stdout"

    - name: Create log directory (if it doesn't exist) in server nodes
      file:
        path: /home/ubuntu/log/
        state: directory
        owner: ubuntu
        mode: 0755

    - name: Remove Kadena server logs
      file: 
        path: "{{ item }}"
        state: absent
      with_items:
          - "/home/ubuntu/log/*.sqlite*"
          - "/home/ubuntu/log/*.log"

    - name: Create necessary log files
      file:
        path: "{{ item }}"
        state: touch
        owner: ubuntu
      with_items:
        - "/home/ubuntu/log/access.log"
        - "/home/ubuntu/log/error.log"
        - "/home/ubuntu/log/node.log"

    - name: Copy node conf file to server
      copy:
        src: /home/ubuntu/conf/{{inventory_hostname}}-cluster.yaml
        dest: /home/ubuntu/conf-cluster.yaml
        owner: ubuntu

    - name: Copy `kadenaserver` executable to server
      copy:
        src: /home/ubuntu/kadena-beta/bin/ubuntu-16.04/kadenaserver
        dest: /home/ubuntu/kadenaserver
        owner: ubuntu
        mode: a+x

- name: Start Kadena Servers
  hosts: kadena_all
  become: True
  vars:
    ansible_python_interpreter: /usr/bin/python3
  gather_facts: True
  tasks:
    - shell: ./kadenaserver +RTS -N4 -RTS -c conf-cluster.yaml 2>&1 | tee -a log/node.log && sleep 1
      async: 1200
      poll: 0
      register: active_servers
    - pause:
        seconds: 2
